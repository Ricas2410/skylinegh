{% extends 'dashboard/base.html' %}
{% block title %}Users{% endblock %}
{% block page_title %}Users{% endblock %}
{% block content %}
<!-- Header -->
<div class="flex items-center justify-between mb-8">
    <div>
        <h2 class="text-2xl font-bold text-gray-900 mb-2">User Management</h2>
        <p class="text-gray-600">Manage user accounts and permissions</p>
    </div>
    <button onclick="openCreateUserModal()" class="btn-primary-submit" style="text-decoration: none;">
        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
        </svg>
        Add New User
    </button>
</div>

<div class="mb-6 flex items-center justify-between">
  <form method="get" class="flex items-center space-x-3">
    <input type="text" name="search" value="{{ request.GET.search }}" placeholder="Search users..." class="px-4 py-2 border border-slate-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
    <button class="btn-secondary">Search</button>
  </form>
</div>

<div class="bg-white rounded-2xl border border-slate-200 overflow-hidden">
  <table class="min-w-full divide-y divide-slate-200">
    <thead class="bg-slate-50">
      <tr>
        <th class="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase">Username</th>
        <th class="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase">Name</th>
        <th class="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase">Email</th>
        <th class="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase">Joined</th>
        <th class="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase">Staff</th>
        <th class="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase">Actions</th>
      </tr>
    </thead>
    <tbody class="divide-y divide-slate-200">
      {% for u in users %}
      <tr class="hover:bg-slate-50">
        <td class="px-4 py-3 font-semibold text-slate-800">{{ u.username }}</td>
        <td class="px-4 py-3 text-slate-700">{{ u.get_full_name|default:'-' }}</td>
        <td class="px-4 py-3 text-slate-700">{{ u.email|default:'-' }}</td>
        <td class="px-4 py-3 text-slate-700">{{ u.date_joined|date:'M j, Y, g:i a' }}</td>
        <td class="px-4 py-3">{% if u.is_staff %}<span class="text-green-600 font-medium">Yes</span>{% else %}<span class="text-slate-500">No</span>{% endif %}</td>
        <td class="px-4 py-3">
          <div class="flex items-center space-x-2">
            <button onclick="openEditUserModal({{ u.id }}, '{{ u.username }}', '{{ u.email }}', '{{ u.first_name }}', '{{ u.last_name }}', {{ u.is_staff|yesno:'true,false' }}, {{ u.is_active|yesno:'true,false' }})" class="text-indigo-600 hover:text-indigo-800 text-sm">Edit</button>
            {% if u != request.user %}
            <button onclick="openDeleteUserModal({{ u.id }}, '{{ u.username }}')" class="text-red-600 hover:text-red-800 text-sm">Delete</button>
            {% endif %}
          </div>
        </td>
      </tr>
      {% empty %}
      <tr>
        <td class="px-4 py-6 text-center text-slate-500" colspan="6">No users found.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

{% if is_paginated %}
<div class="flex justify-between items-center mt-6 text-sm">
  <div class="text-slate-600">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</div>
  <div class="space-x-2">
    {% if page_obj.has_previous %}
      <a href="?page={{ page_obj.previous_page_number }}" class="btn-secondary">Previous</a>
    {% endif %}
    {% if page_obj.has_next %}
      <a href="?page={{ page_obj.next_page_number }}" class="btn-secondary">Next</a>
    {% endif %}
  </div>
</div>
{% endif %}

<!-- Create User Modal -->
<div id="createUserModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
  <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
    <div class="mt-3">
      <h3 class="text-lg font-medium text-gray-900 mb-4">Add New User</h3>
      <form id="createUserForm" method="post" action="{% url 'dashboard:user_create' %}">
        {% csrf_token %}
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Username *</label>
            <input type="text" name="username" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Email *</label>
            <input type="email" name="email" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">First Name</label>
            <input type="text" name="first_name" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Last Name</label>
            <input type="text" name="last_name" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Password *</label>
            <input type="password" name="password1" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Confirm Password *</label>
            <input type="password" name="password2" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
          </div>
          <div class="flex items-center">
            <input type="checkbox" name="is_staff" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
            <label class="ml-2 block text-sm text-gray-900">Staff access (can access admin dashboard)</label>
          </div>
        </div>
        <div class="flex items-center justify-end space-x-3 mt-6">
          <button type="button" onclick="closeCreateUserModal()" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 border border-gray-300 rounded-md hover:bg-gray-200">Cancel</button>
          <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 border border-transparent rounded-md hover:bg-indigo-700">Create User</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Edit User Modal -->
<div id="editUserModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
  <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
    <div class="mt-3">
      <h3 class="text-lg font-medium text-gray-900 mb-4">Edit User</h3>
      <form id="editUserForm" method="post">
        {% csrf_token %}
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Username *</label>
            <input type="text" name="username" id="edit_username" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Email *</label>
            <input type="email" name="email" id="edit_email" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">First Name</label>
            <input type="text" name="first_name" id="edit_first_name" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Last Name</label>
            <input type="text" name="last_name" id="edit_last_name" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
          </div>
          <div class="flex items-center">
            <input type="checkbox" name="is_staff" id="edit_is_staff" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
            <label class="ml-2 block text-sm text-gray-900">Staff access</label>
          </div>
          <div class="flex items-center">
            <input type="checkbox" name="is_active" id="edit_is_active" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
            <label class="ml-2 block text-sm text-gray-900">Active account</label>
          </div>
        </div>
        <div class="flex items-center justify-end space-x-3 mt-6">
          <button type="button" onclick="closeEditUserModal()" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 border border-gray-300 rounded-md hover:bg-gray-200">Cancel</button>
          <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 border border-transparent rounded-md hover:bg-indigo-700">Update User</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Delete User Modal -->
<div id="deleteUserModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
  <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
    <div class="mt-3 text-center">
      <h3 class="text-lg font-medium text-gray-900 mb-4">Delete User</h3>
      <p class="text-sm text-gray-500 mb-6">Are you sure you want to delete user <span id="delete_username" class="font-semibold"></span>? This action cannot be undone.</p>
      <form id="deleteUserForm" method="post">
        {% csrf_token %}
        <div class="flex items-center justify-center space-x-3">
          <button type="button" onclick="closeDeleteUserModal()" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 border border-gray-300 rounded-md hover:bg-gray-200">Cancel</button>
          <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-red-600 border border-transparent rounded-md hover:bg-red-700">Delete User</button>
        </div>
      </form>
    </div>
  </div>
</div>

{% endblock %}

<style>
/* Submit button styling with fallback colors */
.btn-primary-submit {
    background: linear-gradient(135deg, #4f46e5 0%, #3b82f6 100%) !important;
    color: white !important;
    padding: 12px 24px !important;
    border-radius: 12px !important;
    font-weight: 600 !important;
    border: none !important;
    cursor: pointer !important;
    transition: all 0.2s ease !important;
    display: flex !important;
    align-items: center !important;
    box-shadow: 0 4px 12px rgba(79, 70, 229, 0.25) !important;
}

.btn-primary-submit:hover {
    background: linear-gradient(135deg, #3730a3 0%, #1e40af 100%) !important;
    transform: translateY(-1px) !important;
    box-shadow: 0 8px 20px rgba(79, 70, 229, 0.35) !important;
}

.btn-primary-submit:active {
    transform: translateY(0) !important;
    box-shadow: 0 4px 12px rgba(79, 70, 229, 0.25) !important;
}
</style>

<script>
function openCreateUserModal() {
    document.getElementById('createUserModal').classList.remove('hidden');
}

function closeCreateUserModal() {
    document.getElementById('createUserModal').classList.add('hidden');
}

function openEditUserModal(userId, username, email, firstName, lastName, isStaff, isActive) {
    document.getElementById('edit_username').value = username;
    document.getElementById('edit_email').value = email;
    document.getElementById('edit_first_name').value = firstName;
    document.getElementById('edit_last_name').value = lastName;
    document.getElementById('edit_is_staff').checked = isStaff;
    document.getElementById('edit_is_active').checked = isActive;

    document.getElementById('editUserForm').action = `/my-admin/users/${userId}/edit/`;
    document.getElementById('editUserModal').classList.remove('hidden');
}

function closeEditUserModal() {
    document.getElementById('editUserModal').classList.add('hidden');
}

function openDeleteUserModal(userId, username) {
    document.getElementById('delete_username').textContent = username;
    document.getElementById('deleteUserForm').action = `/my-admin/users/${userId}/delete/`;
    document.getElementById('deleteUserModal').classList.remove('hidden');
}

function closeDeleteUserModal() {
    document.getElementById('deleteUserModal').classList.add('hidden');
}

// Close modals when clicking outside
window.onclick = function(event) {
    const createModal = document.getElementById('createUserModal');
    const editModal = document.getElementById('editUserModal');
    const deleteModal = document.getElementById('deleteUserModal');

    if (event.target == createModal) {
        closeCreateUserModal();
    }
    if (event.target == editModal) {
        closeEditUserModal();
    }
    if (event.target == deleteModal) {
        closeDeleteUserModal();
    }
}
</script>
