{% extends 'dashboard/base.html' %}
{% block title %}Restore Backup{% endblock %}
{% block page_title %}Restore Backup{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto bg-white rounded-2xl p-6 border border-slate-200 shadow-sm">
    <h3 class="text-lg font-semibold text-gray-900 mb-6">Upload Backup File</h3>
    <p class="text-sm text-slate-600 mb-6">
        Upload a previously created backup file (<code>.json</code> or <code>.zip</code>) to restore your site's data and media.
        <strong>Warning:</strong> Restoring a backup will overwrite existing data. Proceed with caution.
    </p>

    <form id="restoreForm" method="post" enctype="multipart/form-data" class="space-y-6">
        {% csrf_token %}
        <div>
            <label for="backup_file" class="block text-sm font-medium text-slate-700 mb-2">Select Backup File</label>
            <input type="file" name="backup_file" id="backup_file" accept=".json,.zip" required
                   class="block w-full text-sm text-slate-500
                          file:mr-4 file:py-2 file:px-4
                          file:rounded-full file:border-0
                          file:text-sm file:font-semibold
                          file:bg-indigo-50 file:text-indigo-700
                          hover:file:bg-indigo-100"/>
            <p class="mt-2 text-xs text-slate-500">Accepted formats: .json (database only) or .zip (database + media files)</p>
        </div>

        <div class="flex justify-end">
            <button type="submit" class="btn-primary" id="restoreButton">
                Restore Backup
            </button>
        </div>
    </form>

    <div id="restoreStatus" class="mt-6 p-4 rounded-lg text-sm hidden" role="alert"></div>

    <h3 class="text-lg font-semibold text-gray-900 mt-10 mb-6">Backup History</h3>
    <div id="backupHistory" class="space-y-4">
        <p class="text-slate-600">Loading backup history...</p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const restoreForm = document.getElementById('restoreForm');
    const restoreButton = document.getElementById('restoreButton');
    const restoreStatus = document.getElementById('restoreStatus');
    const backupHistoryDiv = document.getElementById('backupHistory');

    function showStatus(message, type = 'info') {
        restoreStatus.textContent = message;
        restoreStatus.classList.remove('hidden', 'bg-green-100', 'text-green-800', 'bg-red-100', 'text-red-800', 'bg-blue-100', 'text-blue-800');
        if (type === 'success') {
            restoreStatus.classList.add('bg-green-100', 'text-green-800');
        } else if (type === 'error') {
            restoreStatus.classList.add('bg-red-100', 'text-red-800');
        } else {
            restoreStatus.classList.add('bg-blue-100', 'text-blue-800');
        }
        restoreStatus.classList.remove('hidden');
    }

    restoreForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        showStatus('Restoring backup... This may take a moment.', 'info');
        restoreButton.disabled = true;

        const formData = new FormData(restoreForm);
        const fileInput = document.getElementById('backup_file');
        if (fileInput.files.length === 0) {
            showStatus('Please select a backup file to upload.', 'error');
            restoreButton.disabled = false;
            return;
        }

        try {
            const response = await fetch('{% url "dashboard:admin_restore_api" %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            });

            const data = await response.json();

            if (data.success) {
                showStatus(data.message, 'success');
                // Reload page after a short delay to reflect changes
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            } else {
                showStatus(`Error: ${data.error}`, 'error');
            }
        } catch (error) {
            showStatus(`Network error: ${error.message}`, 'error');
        } finally {
            restoreButton.disabled = false;
        }
    });

    async function fetchBackupHistory() {
        try {
            const response = await fetch('{% url "dashboard:admin_backup_history_api" %}');
            const data = await response.json();

            if (data.success) {
                if (data.backups.length > 0) {
                    backupHistoryDiv.innerHTML = ''; // Clear loading message
                    data.backups.forEach(backup => {
                        const backupItem = document.createElement('div');
                        backupItem.className = 'flex items-center justify-between p-3 border border-slate-200 rounded-lg';
                        backupItem.innerHTML = `
                            <div>
                                <p class="font-medium text-slate-800">${backup.name}</p>
                                <p class="text-xs text-slate-500">Size: ${backup.size} | Date: ${backup.date}</p>
                            </div>
                            <div class="flex space-x-2">
                                <a href="{% url 'dashboard:admin_download_backup_api' %}?path=${encodeURIComponent(backup.path)}" class="text-indigo-600 hover:text-indigo-900 text-sm">Download</a>
                                <button type="button" class="text-rose-600 hover:text-rose-900 text-sm delete-backup-btn" data-path="${backup.path}">Delete</button>
                            </div>
                        `;
                        backupHistoryDiv.appendChild(backupItem);
                    });

                    // Add event listeners for delete buttons
                    document.querySelectorAll('.delete-backup-btn').forEach(button => {
                        button.addEventListener('click', async function() {
                            if (confirm('Are you sure you want to delete this backup? This action cannot be undone.')) {
                                const backupPath = this.dataset.path;
                                try {
                                    const response = await fetch('{% url "dashboard:admin_delete_backup_api" %}', {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/json',
                                            'X-CSRFToken': '{{ csrf_token }}'
                                        },
                                        body: JSON.stringify({ path: backupPath })
                                    });
                                    const data = await response.json();
                                    if (data.success) {
                                        showStatus(data.message, 'success');
                                        fetchBackupHistory(); // Refresh list
                                    } else {
                                        showStatus(`Error deleting backup: ${data.error}`, 'error');
                                    }
                                } catch (error) {
                                    showStatus(`Network error: ${error.message}`, 'error');
                                }
                            }
                        });
                    });

                } else {
                    backupHistoryDiv.innerHTML = '<p class="text-slate-600">No backups found.</p>';
                }
            } else {
                backupHistoryDiv.innerHTML = `<p class="text-rose-600">Error loading backup history: ${data.error}</p>`;
            }
        } catch (error) {
            backupHistoryDiv.innerHTML = `<p class="text-rose-600">Network error loading backup history: ${error.message}</p>`;
        }
    }

    fetchBackupHistory();
});
</script>
{% endblock %}
